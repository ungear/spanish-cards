<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spanish Cards - List</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="list.css" rel="stylesheet">
</head>
<body>
  <header class="bg-gray-500 h-12"></header>
  
  <main>
    <nav class="flex justify-between bg-gray-200">
      <ul class="flex space-x-4 p-4">
        <li><a href="/list.html" class="text-blue-500">List</a></li>
        <li><a href="/add.html" class="text-blue-500">Add</a></li>
        <li><a href="/training.html" class="text-blue-500">Training</a></li>
        <li><a href="/training.html?mode=reverse" class="text-blue-500">Reverse</a></li>
      </ul>
      <div id="current-user"></div>
    </nav>
    <section class="list-content">
      <section class="p-4 flex justify-end">
        <button id="resetAll" class="bg-red-500 text-white text-sm px-2 py-0.5 rounded-md">Reset All</button>
      </section>
      <table>
        <thead class="bg-gray-200" id="gridHeader">
          <tr>
            <th class="py-2 px-4 font-bold cursor-pointer" data-sorting-column="word">Word</th> 
            <th class="py-2 px-4 font-bold cursor-pointer" data-sorting-column="level">Level</th>
            <th class="py-2 px-4 font-bold cursor-pointer" data-sorting-column="next_repeat">Next Repeat</th>
            <th class="py-2 px-4 font-bold cursor-pointer" data-sorting-column="translation">Translation</th>
            <th class="py-2 px-4 font-bold cursor-pointer" data-sorting-column="example">Example</th>
          </tr>
        </thead>  
        <tbody id="gridBody">
        </tbody>
      </table>
    </section>
  </main>

  <script src="utils.js"></script>
  <script src="js/currentUser.js"></script>
  <script lang="javascript">
    class State extends EventTarget{
      constructor(){
        super();
        this._cards = [];
        this._sorting = {
          column: 'word',
          order: 'asc'
        };
        this.events = {
          cardsLoaded: 'cardsLoaded',
          sortingChanged: 'sortingChanged'
        }
      }
      get cards(){
        return this._cards;
      }
      set cards(value){
        this._cards = value;
        this.dispatchEvent(new Event(this.events.cardsLoaded));
      } 
      get sorting(){
        return this._sorting;
      }
      set sorting(value){
        this._sorting = value;
        this.dispatchEvent(new Event(this.events.sortingChanged));
      }
    }
    const state = new State();

    state.addEventListener(state.events.cardsLoaded, (event) => {
      renderRows(state.cards);
    });

    state.addEventListener(state.events.sortingChanged, (event) => {
      sortCards(state.cards, state.sorting.column, state.sorting.order);
      renderRows(state.cards);
    });

    document.addEventListener("DOMContentLoaded", loadAllCards)

    document.getElementById('gridHeader').addEventListener('click', onHeaderClick);

    document.getElementById('resetAll').addEventListener('click', () => {
      const promise =  fetch('/api/card/resetAll', {
        method: 'POST',
      })
      .then(loadAllCards)
      .catch(error => console.error('Error resetting cards:', error));

      disableButtonWhileLoading(this, promise);
    });

    function onHeaderClick(event){
      if(event.target.dataset.sortingColumn){
        const column = event.target.dataset.sortingColumn;
        const sorting = state.sorting;
        sorting.column = column;
        sorting.order = state.sorting.order === 'asc' ? 'desc' : 'asc';
        state.sorting = sorting;
      }
    }

    function loadAllCards(){
      fetch('/api/card')
        .then(response => response.json())
        .then(response => {
          state.cards = response;
        })
        .catch(error => console.error('Error fetching cards:', error));
    }

    function sortCards(cards, column, order){
      cards.sort((a, b) => {
        if(a[column] === b[column]) return 0;
        if (order === 'asc') {
          return a[column] < b[column] ? -1 : 1 ;
        } else {
          return b[column] < a[column] ? -1 : 1;
        }
      });
    }

    function renderRows(cards){
      const wordsDiv = document.getElementById('gridBody');
      wordsDiv.innerHTML = cards.map(card => `
        <tr class="border-b border-gray-300">
          <td class="py-2 px-4 font-bold">${card.word}</td>
          <td class="py-2 px-4 font-bold">${card.level}</td>
          <td class="py-2 px-4 font-bold">${card.next_repeat}</td>
          <td class="py-2 px-4 text-gray-600">${card.translation}</td>
          <td class="py-2 px-4 text-gray-500 italic">${card.example || ''}</td>
        </tr>
      `).join('');
    }
  </script>
</body>
</html> 